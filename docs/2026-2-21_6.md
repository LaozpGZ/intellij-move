# 2026-02-21 进展记录（P1：positional fields 补齐类型链路）

## 本次目标
- 在 `revised paths` 完成后，继续推进 GAP-SUI-01，补齐 positional fields 在 **pattern 解构** 场景下的类型推断与检查闭环。

## 问题定位
- `src/main/kotlin/org/sui/lang/core/types/infer/Patterns.kt` 在 `MvPatStruct` 分支里仍只用 `item.fields`（named fields）做字段映射。
- 对 `let S { 0: first, 1: second } = s;` 这类 numeric pattern，字段类型会退化为 `TyUnknown`，导致：
  - 绑定变量类型推断不准确；
  - 类型检查无法稳定报出期望的不兼容错误。

## 代码改动

1. 统一字段抽象入口（覆盖 tuple fields）
- `src/main/kotlin/org/sui/lang/core/psi/ext/MvFieldsOwner.kt`
  - `fields` 从仅 named fields 调整为返回 `allFields`。

2. 修复 numeric struct pattern 的字段类型推断
- `src/main/kotlin/org/sui/lang/core/types/infer/Patterns.kt`
  - `MvPatStruct` 分支改为基于 `item.allFields` 建立字段映射；
  - 字段类型获取改为 `fieldTy(...)`，同时保留泛型替换逻辑。

3. 新增回归测试（types + inspection）
- `src/test/kotlin/org/sui/lang/types/ExpressionTypesTest.kt`
  - `test type of binding from numeric struct pattern`
  - `test type of second binding from numeric struct pattern`
- `src/test/kotlin/org/sui/ide/inspections/MvTypeCheckInspectionTest.kt`
  - `test type check for numeric struct pattern bindings`

## 验证结果

执行命令：

```bash
./gradlew test --tests "org.sui.lang.types.ExpressionTypesTest.test type of binding from numeric struct pattern" \
               --tests "org.sui.lang.types.ExpressionTypesTest.test type of second binding from numeric struct pattern" \
               --tests "org.sui.ide.inspections.MvTypeCheckInspectionTest.test type check for numeric struct pattern bindings" \
               --no-daemon

./gradlew test --tests "org.sui.lang.types.ExpressionTypesTest" \
               --tests "org.sui.ide.inspections.MvTypeCheckInspectionTest" \
               --tests "org.sui.lang.resolve.ResolveStructFieldsTest" \
               --no-daemon

./gradlew test --no-daemon

./gradlew verifyPlugin --no-daemon

ORG_GRADLE_PROJECT_shortPlatformVersion=261 ./gradlew verifyPlugin --no-daemon
```

结果：
- `BUILD SUCCESSFUL`
- `verifyPlugin`: `Compatible (IU-253.31033.19)`，并输出 `12 scheduled-for-removal / 28 deprecated / 119 experimental / 4 internal`
- `261 verifyPlugin`: `Compatible (IU-261.21525.39)`，并输出 `12 scheduled-for-removal / 38 deprecated / 119 experimental / 4 internal`
- 备注：校验期间出现 `Unable to fetch documented IntelliJ API incompatible changes (SSLHandshakeException)` 日志，任务最终仍成功，不影响本次兼容性结论。

## 当前结论
- positional fields 在 `struct pattern`（`S { 0: ..., 1: ... }`）场景下的类型链路已闭环；
- 对应 inspection 错误提示已可稳定触发；
- GAP-SUI-01（positional fields）已按当前 DoD 收口。
