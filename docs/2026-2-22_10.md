GAP-SUI-08 阶段 B/C 推进开发记录（2026-02-22）

## 1. 本轮目标

1. 落地 `verifyPlugin` 预算治理（阶段 B/C 门禁机制）
2. 推进阶段 C 批次 1：
   - `runReadAction`
   - `UiCompatibleDataProvider.getData`
   - `ProcessAdapter`
3. 推进阶段 C 批次 2：
   - `Decompressor.Zip/Tar(File)`
   - `extract(File)`

## 2. 阶段 B/C 预算治理落地结果

- 新增预算摘要脚本：`.github/scripts/plugin-verifier-summary.sh`
- CI 接入双轨门禁：`.github/workflows/check.yml`
  - `253`：`strict`
  - `261`：`warn`
- 新增预算变量：
  - `PLUGIN_VERIFIER_MAX_INTERNAL_API_USAGES`
  - `PLUGIN_VERIFIER_MAX_SCHEDULED_FOR_REMOVAL_API_USAGES`
  - `PLUGIN_VERIFIER_MAX_DEPRECATED_API_USAGES`
  - `PLUGIN_VERIFIER_BUDGET_ENFORCEMENT`
- 治理文档更新：`docs/verifyplugin-hardening.md`

## 3. 阶段 C 批次 1（已完成）

替换范围：

- `ActionsKt.runReadAction(...)`
- `UiCompatibleDataProvider.getData(...)` 覆盖点
- `ProcessAdapter` 继承点

核心变更文件：

- `src/main/kotlin/org/sui/cli/toolwindow/AptosToolWindow.kt`
- `src/main/kotlin/org/sui/cli/toolwindow/SuiToolWindow.kt`
- `src/main/kotlin/org/sui/cli/toolwindow/MoveProjectsTreeStructure.kt`
- `src/main/kotlin/org/sui/cli/MoveProjectsSyncTask.kt`
- `src/main/kotlin/org/sui/cli/runConfigurations/buildtool/AptosBuildAdapterBase.kt`
- `src/main/kotlin/org/sui/ide/annotator/RsExternalLinterPass.kt`
- `src/main/kotlin/org/sui/ide/inspections/MvExternalLinterInspection.kt`
- `src/main/kotlin/org/sui/openapiext/CommandLineExt.kt`

## 4. 阶段 C 批次 2（已完成）

替换范围：

- `Decompressor.Zip(File)` -> `Decompressor.Zip(Path)`
- `Decompressor.Tar(File)` -> `Decompressor.Tar(Path)`
- `extract(File)` -> `extract(Path)`

核心变更文件：

- `src/main/kotlin/org/sui/cli/sdks/DownloadAptosSdkTask.kt`
- `src/main/kotlin/org/sui/cli/sdks/DownloadSuiSdkTask.kt`

## 5. 指标变化（verifyPlugin）

基线（2026-02-22）：

- `253`：`scheduled=12, deprecated=28, experimental=119`
- `261`：`scheduled=12, deprecated=38, experimental=119`

批次 1 后：

- `253`：`scheduled=12, deprecated=20, experimental=119`
- `261`：`scheduled=12, deprecated=21, experimental=119`

批次 2 后：

- `253`：`scheduled=12, deprecated=16, experimental=119`
- `261`：`scheduled=12, deprecated=17, experimental=119`

累计降幅（相对基线）：

- `253 deprecated`：`28 -> 16`（-12）
- `261 deprecated`：`38 -> 17`（-21）

## 6. 已完成提交

- `d52cb49b` `chore: add verifier budgets for scheduled and deprecated usages`
- `6bd1e1f4` `refactor: replace deprecated read/data/process APIs`

## 7. 本轮验证命令

- `./gradlew compileKotlin -Pkotlin.incremental=false --no-daemon`
- `./gradlew verifyPlugin -Pkotlin.incremental=false --no-daemon`
- `ORG_GRADLE_PROJECT_shortPlatformVersion=261 ./gradlew verifyPlugin -Pkotlin.incremental=false --no-daemon`

说明：

- 有一次 `verifyPlugin` 执行出现外部仓库网络抖动（`StreamResetException: CANCEL`），重跑后通过。
- 最终两条线均 `BUILD SUCCESSFUL`，并产出可用报告。

## 8. 下一步建议（阶段 C 批次 3）

- 目标：`ConcurrentWeakKeySoftValueHashMap` 替换与回归验证
- 预期：继续压降 `DEPRECATED_API_USAGES`，保持 `scheduled=12` 不回升
