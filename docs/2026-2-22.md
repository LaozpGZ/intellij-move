# 2026-02-22 进展记录（P1：match guard-aware diagnostics 完成）

## 本次目标
- 承接 `docs/2026-2-21_7.md` 的下一步计划，完成 GAP-SUI-04：`match` 诊断在 guard 场景下的覆盖性、不可达与穷尽性判定补齐。

## 规则收敛
1. 覆盖性计入规则（不做复杂控制流分析）：
- **仅无 guard 的分支**计入“已覆盖”集合；
- `E::A if cond` 视为“部分覆盖”，不让 `match` 变穷尽；
- `_ if cond` 不是 catch-all，`_` 才是 catch-all。

2. 不可达判定规则：
- 无 guard 的 catch-all 之后，后续分支不可达；
- 枚举全部变体已被无 guard 分支覆盖后，后续分支不可达；
- 若某变体已被无 guard 分支覆盖，则该变体的 guarded 分支不可达（`E::A` 在前，`E::A if ...` 在后）。

## 代码改动
1. `src/main/kotlin/org/sui/ide/annotator/MvErrorAnnotator.kt`
- `MatchArmVariant` 增加 `hasGuard`，不再在提取阶段直接丢弃 guarded arm；
- duplicate 检查仅统计无 guard 的 variant；
- unreachable 检查改为顺序扫描 + 覆盖状态机（catch-all / enum fully covered / guarded 同变体不可达）；
- exhaustiveness 覆盖集合仅计入无 guard 的 variant。

2. `src/test/kotlin/org/sui/ide/annotator/errors/MatchArmDuplicateErrorTest.kt`
- 新增 guarded/unguarded 混合边界回归：
  - `test guarded enum arm is unreachable after unguarded same variant`
  - `test guarded enum arm does not make match exhaustive`
  - `test wildcard arm after guarded wildcard is reachable`
  - `test guarded wildcard arm is unreachable after wildcard`

3. 任务文档同步
- `docs/github-issues/sui-move-2024/04-match-guard-aware-diagnostics.md` 任务与 DoD 全部勾选完成。

## 验证结果
执行命令：

```bash
./gradlew test --tests "org.sui.ide.annotator.errors.MatchArmDuplicateErrorTest" --no-daemon
./gradlew test --tests "org.sui.ide.annotator.errors.*" --no-daemon
./gradlew test --no-daemon
./gradlew verifyPlugin --no-daemon
ORG_GRADLE_PROJECT_shortPlatformVersion=261 ./gradlew verifyPlugin --no-daemon
```

结果：
- 全部 `BUILD SUCCESSFUL`；
- `verifyPlugin (253)`：`Compatible (IU-253.31033.19)`；
- `verifyPlugin (261)`：`Compatible (IU-261.21525.39)`；
- 验证期间仍有既有 verifier 噪音日志（layout components/caffeine invalid state），不影响本次结论。

## 当前结论
- GAP-SUI-04（match guard-aware diagnostics）已闭环并具备回归保护；
- P1 剩余项可继续转向 GAP-SUI-05（equality automatic referencing）。
