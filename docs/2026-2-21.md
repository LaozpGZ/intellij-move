# 2026-02-21 进展记录（M1 收口 + M2 工具链修复）

## 1. 背景
- 主线目标：`253` 稳定门禁 + `261` 预验证。
- 当日阻塞：`261` 下 `generateParser` 报错 `NoClassDefFoundError: com/intellij/openapi/util/KeyedExtensionCollector`，只能依赖 CI 临时参数 `-x generateLexer -x generateParser`。

## 2. 本次完成
- 升级 GrammarKit Gradle 插件：`build.gradle.kts`
  - `org.jetbrains.grammarkit` 从 `2023.3.0.1` 升级到 `2023.3.0.2`。
- 修复 261 生成链：
  - `ORG_GRADLE_PROJECT_shortPlatformVersion=261 ./gradlew generateParser` 成功。
  - 261 不再需要跳过 `generateLexer/generateParser`。
- 回收 CI 临时绕过：`.github/workflows/check.yml`
  - `eap-preverify` 的 Build 步骤移除 `-x generateLexer -x generateParser`。
  - `eap-preverify` 的 Verify plugin 步骤移除 `-x generateLexer -x generateParser`。
- 目标文档同步：`docs/2026-1_todo.md`
  - 261 风险从“已失败+临时跳过”更新为“已修复+持续监控”。

## 3. 本地验证结果
### 3.1 261（EAP 线）
- `ORG_GRADLE_PROJECT_shortPlatformVersion=261 ./gradlew generateParser --no-daemon --stacktrace`
  - `BUILD SUCCESSFUL`
- `ORG_GRADLE_PROJECT_shortPlatformVersion=261 ./gradlew verifyPluginProjectConfiguration verifyPlugin -Pkotlin.incremental=false --no-daemon`
  - `BUILD SUCCESSFUL`
  - Verifier：`Compatible (IU-261.21525.39)`
  - 指标：`12 scheduled-for-removal / 38 deprecated / 119 experimental / 4 internal`

### 3.2 253（主线）
- `ORG_GRADLE_PROJECT_shortPlatformVersion=253 ./gradlew test -Pkotlin.incremental=false --no-daemon`
  - `BUILD SUCCESSFUL`
- `ORG_GRADLE_PROJECT_shortPlatformVersion=253 ./gradlew verifyPluginProjectConfiguration verifyPlugin -Pkotlin.incremental=false --no-daemon`
  - `BUILD SUCCESSFUL`
  - Verifier：`Compatible (IU-253.31033.19)`
  - 指标：`12 scheduled-for-removal / 28 deprecated / 119 experimental / 4 internal`

## 4. 当前结论
- M1 平台门禁已完成并稳定：`253` 与 `261` 均可全链路构建与验证。
- M2 工具链兼容阻塞已解除：261 不再依赖 skip 参数。
- 目前可以把后续精力集中到 Move 2024 功能缺口（parser/resolve/types/inspection/completion）而不是构建链兜底。

## 5. 下一步详细规划（执行顺序）
1. CI 观察窗（2-3 天）
- 目标：确认 `tests(253)` + `eap-preverify(261)` 连续稳定。
- 通过标准：连续 3 次绿色。

2. Move 2024 缺口攻坚（M3）
- P1：`positional fields`
  - 模块：parser + resolve + types + inspection
  - 交付：语法、解析、类型与诊断链路闭环 + 回归测试。
- P1：`break value`
  - 模块：parser + types + annotator
  - 交付：含 label 场景和类型汇合规则。
- P1：`revised paths`
  - 模块：parser + resolve + completion
  - 交付：`::std::...` 等全局路径一致行为。

3. 回归与发布收口（M4）
- 自动化：补齐新增场景测试并纳入常规门禁。
- 文档：更新支持范围、迁移建议、已知限制。
- 发布：`buildPlugin` + 手工样例验收 + 发布说明。
